<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Pix - InvictusPay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    #loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .card {
      border-radius: 15px;
    }
    .btn-primary {
      background: linear-gradient(45deg, #4e54c8, #8f94fb);
      border: none;
      border-radius: 8px;
      padding: 12px;
    }
    .btn-primary:hover {
      background: linear-gradient(45deg, #3a3f9e, #6c71e0);
    }
  </style>
</head>
<body class="bg-light">

<!-- üîπ Loading escondido inicialmente -->
<div id="loading" class="d-none d-flex">
  <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
  <p class="mt-3">Gerando Pix, aguarde...</p>
</div>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">

      <div class="card shadow-lg border-0 rounded-4">
        <div class="card-body p-4">
          <h3 class="text-center mb-4">Gerador de Pix</h3>
          <p class="text-muted text-center mb-4">Preencha os dados abaixo para gerar um c√≥digo PIX</p>

          <form id="pixForm">
            <div class="mb-3">
              <label for="titulo" class="form-label">T√≠tulo da Transa√ß√£o</label>
              <input type="text" class="form-control" id="titulo" name="titulo" placeholder="Ex: Pedido #1234" required>
            </div>

            <div class="mb-3">
              <label for="valor" class="form-label">Valor (R$)</label>
              <input type="number" step="0.01" class="form-control" id="valor" name="valor" placeholder="Ex: 25.90" required>
            </div>
            
            <div class="mb-3">
              <label for="nome" class="form-label">Nome do Cliente</label>
              <input type="text" class="form-control" id="nome" name="nome" placeholder="Nome completo" required>
            </div>
            
            <div class="mb-3">
              <label for="email" class="form-label">E-mail</label>
              <input type="email" class="form-control" id="email" name="email" placeholder="email@exemplo.com" required>
            </div>
            
            <div class="mb-3">
              <label for="telefone" class="form-label">Telefone</label>
              <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(11) 99999-9999" required>
            </div>
            
            <div class="mb-3">
              <label for="cpf" class="form-label">CPF</label>
              <input type="text" class="form-control" id="cpf" name="cpf" placeholder="000.000.000-00" required>
            </div>

            <button type="submit" class="btn btn-primary w-100">Gerar Pix</button>
          </form>

          <div id="resultado" class="mt-4 d-none">
            <h5 class="text-success">C√≥digo Copia e Cola:</h5>
            <textarea id="pixCode" class="form-control mb-2" rows="4" readonly></textarea>
            <button class="btn btn-outline-success w-100 mb-3" onclick="copiarCodigo()">üìã Copiar C√≥digo</button>

            <h5 class="text-primary text-center">QR Code</h5>
            <div class="text-center">
              <canvas id="qrcode"></canvas>
            </div>
            <p class="text-muted mt-2" id="pixExpire"></p>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
// Configura√ß√µes da API
const API_ENDPOINT = "https://api.invictuspay.app.br/api";
// Seu token de API
const API_TOKEN = "3RKGj6JwDMbFSn9effKOuVwwQWi4ucS7m1V3YTg4tblAQrp9ZBu5ZcA53LBL";

document.getElementById("pixForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const valor = document.getElementById("valor").value;
  const titulo = document.getElementById("titulo").value;
  const nome = document.getElementById("nome").value;
  const email = document.getElementById("email").value;
  const telefone = document.getElementById("telefone").value;
  const cpf = document.getElementById("cpf").value;
  
  gerarPix(valor, titulo, nome, email, telefone, cpf);
});

async function gerarPix(valor, titulo, nome, email, telefone, cpf) {
  const loading = document.getElementById("loading");
  try {
    // mostra loading
    loading.classList.remove("d-none");

    // Converter valor para centavos (formato da API)
    const valorCentavos = Math.round(valor * 100);
    
    // Preparar dados para a API
    const dadosTransacao = {
      amount: valorCentavos,
      payment_method: "pix",
      customer: {
        name: nome,
        email: email,
        phone_number: telefone.replace(/\D/g, ''), // Remove caracteres n√£o num√©ricos
        document: cpf.replace(/\D/g, '') // Remove caracteres n√£o num√©ricos
      },
      cart: [
        {
          title: titulo,
          price: valorCentavos,
          quantity: 1,
          operation_type: 1,
          tangible: false
        }
      ],
      installments: 1,
      expire_in_days: 1,
      transaction_origin: "api"
    };

    const response = await fetch(`${API_ENDPOINT}/public/v1/transactions?api_token=${API_TOKEN}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify(dadosTransacao)
    });

    // sempre esconde loading depois da resposta
    loading.classList.add("d-none");

    if (!response.ok) {
      const text = await response.text();
      throw new Error("Erro HTTP: " + response.status + " ‚Üí " + text);
    }

    const data = await response.json();
    console.log("Resposta PIX:", data);

    // Verificar se a transa√ß√£o foi criada com sucesso
    if (data.status === "success" && data.transaction) {
      // Buscar detalhes da transa√ß√£o para obter o QR Code
      const transactionHash = data.transaction.hash;
      const detailResponse = await fetch(`${API_ENDPOINT}/public/v1/transactions/${transactionHash}?api_token=${API_TOKEN}`);
      
      if (!detailResponse.ok) {
        throw new Error("Erro ao buscar detalhes da transa√ß√£o");
      }
      
      const detailData = await detailResponse.json();
      
      // Verificar se temos o QR Code
      if (detailData.transaction && detailData.transaction.pix_qrcode) {
        const codigo = detailData.transaction.pix_qrcode;
        
        document.getElementById("pixCode").value = codigo;
        document.getElementById("resultado").classList.remove("d-none");

        // Gera QR Code
        const canvas = document.getElementById("qrcode");
        QRCode.toCanvas(canvas, codigo, { width: 220 }, function (error) {
          if (error) console.error(error);
        });

        // Mostra data de expira√ß√£o
        const expireDate = new Date();
        expireDate.setDate(expireDate.getDate() + 1); // Adiciona 1 dia
        document.getElementById("pixExpire").textContent = "Expira em: " + expireDate.toLocaleString('pt-BR');
      } else {
        throw new Error("QR Code n√£o encontrado na resposta");
      }
    } else {
      throw new Error("Falha ao criar transa√ß√£o: " + (data.message || "Erro desconhecido"));
    }

  } catch (err) {
    loading.classList.add("d-none");
    console.error("Erro ao gerar Pix:", err);
    alert("Erro ao gerar Pix: " + err.message);
  }
}

function copiarCodigo() {
  const pixCode = document.getElementById("pixCode");
  pixCode.select();
  pixCode.setSelectionRange(0, 99999); // mobile
  document.execCommand("copy");
  alert("C√≥digo Pix copiado!");
}

// M√°scaras para os campos
document.getElementById('telefone').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length <= 10) {
    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
  } else {
    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
  }
  e.target.value = value;
});

document.getElementById('cpf').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
  e.target.value = value;
});
</script>

</body>
</html>